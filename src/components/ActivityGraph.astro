---
import type { DayActivity } from "../types/strava";

type Props = {
	activities: DayActivity[];
};

const { activities } = Astro.props;

// Calculate summary stats
const totalSwim = activities.reduce((sum, day) => sum + (day.swim || 0), 0);
const totalRun = activities.reduce((sum, day) => sum + (day.run || 0), 0);
const totalRide = activities.reduce((sum, day) => sum + (day.ride || 0), 0);
const activeDays = activities.filter(
	(day) => day.swim || day.run || day.ride,
).length;

// Calculate max height for normalization (convert swim to km for comparison)
const maxHeight = Math.max(
	...activities.map(
		(day) => (day.swim || 0) / 1000 + (day.run || 0) + (day.ride || 0),
	),
	1,
);

const formatDistance = (value: number, unit: "m" | "km") => {
	if (unit === "m") {
		return new Intl.NumberFormat("en-US").format(Math.round(value));
	}
	return new Intl.NumberFormat("en-US", {
		minimumFractionDigits: 1,
		maximumFractionDigits: 1,
	}).format(value);
};

const formatDate = (dateStr: string) => {
	const date = new Date(dateStr + "T00:00:00");
	return new Intl.DateTimeFormat("en-US", {
		month: "short",
		day: "numeric",
		year: "numeric",
	}).format(date);
};
---

<div class="mt-8">
	<!-- Summary Stats -->
	<div
		class="mb-12 grid grid-cols-2 gap-6 rounded-lg bg-gray-200 p-6 sm:grid-cols-4"
	>
		<div class="flex flex-col gap-1">
			<span class="font-mono text-sm text-gray-1100">Active days</span>
			<span class="font-mono text-xl font-bold text-gray-1200">{activeDays}</span
			>
		</div>
		<div class="flex flex-col gap-1">
			<span class="font-mono text-sm text-gray-1100">Swim</span>
			<span class="font-mono text-xl font-bold text-gray-1200"
				>{formatDistance(totalSwim, "m")} m</span
			>
		</div>
		<div class="flex flex-col gap-1">
			<span class="font-mono text-sm text-gray-1100">Run</span>
			<span class="font-mono text-xl font-bold text-gray-1200"
				>{formatDistance(totalRun, "km")} km</span
			>
		</div>
		<div class="flex flex-col gap-1">
			<span class="font-mono text-sm text-gray-1100">Ride</span>
			<span class="font-mono text-xl font-bold text-gray-1200"
				>{formatDistance(totalRide, "km")} km</span
			>
		</div>
	</div>

	<!-- Activity Graph -->
	<div class="overflow-x-auto py-4">
		<div class="activity-graph">
			{
				activities.map((day) => {
					const swimKm = (day.swim || 0) / 1000;
					const runKm = day.run || 0;
					const rideKm = day.ride || 0;

					// Calculate heights as pixels (200px max height)
					const swimPx = (swimKm / maxHeight) * 200;
					const runPx = (runKm / maxHeight) * 200;
					const ridePx = (rideKm / maxHeight) * 200;

					const hasActivity = day.swim || day.run || day.ride;

					return (
						<div class="activity-day relative flex h-[200px] flex-col justify-end">
							{hasActivity ? (
								<div class="activity-bar">
									{day.ride && (
										<div
											class="w-full bg-gray-700"
											style={`height: ${ridePx}px`}
										/>
									)}
									{day.run && (
										<div
											class="w-full bg-gray-900"
											style={`height: ${runPx}px`}
										/>
									)}
									{day.swim && (
										<div
											class="w-full bg-gray-1100"
											style={`height: ${swimPx}px`}
										/>
									)}
								</div>
							) : (
								<div class="h-px w-full bg-gray-400" />
							)}
							<div class="activity-tooltip whitespace-nowrap rounded-md border border-gray-600 bg-gray-100 p-3 shadow-lg">
								<div class="mb-2 font-mono text-sm font-semibold text-gray-1200">
									{formatDate(day.date)}
								</div>
								{day.swim && (
									<div class="mb-1 font-mono text-sm text-gray-1100">
										üèä {formatDistance(day.swim, "m")} m
									</div>
								)}
								{day.run && (
									<div class="mb-1 font-mono text-sm text-gray-1100">
										üèÉ {formatDistance(day.run, "km")} km
									</div>
								)}
								{day.ride && (
									<div class="font-mono text-sm text-gray-1100">
										üö¥ {formatDistance(day.ride, "km")} km
									</div>
								)}
								{!hasActivity && (
									<div class="font-mono text-sm text-gray-900">Rest day</div>
								)}
							</div>
						</div>
					);
				})
			}
		</div>
	</div>
</div>
